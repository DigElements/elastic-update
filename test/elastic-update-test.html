<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../elasticsearch/elasticsearch.js"></script>
    <link rel="import" href="../elastic-update.html">
  </head>

  <body>
    <test-fixture id="elastic-update-fixture">
      <template>
        <elastic-update index="mockads" id="3" elastic-type="ad" 
          results="{{data}}" error="{{error}}">
        </elastic-update>
      </template>
    </test-fixture>

    <test-fixture id="bad-id">
      <template>
        <elastic-update index="mockads" id="2didk" elastic-type="ad" 
          results="{{data}}" last-error="{{error}}">
        </elastic-update>
      </template>
    </test-fixture>

    <script>
      var client, esUpdate, esUpdateBad;

      suite('<elastic-update>', function() {
        setup(function() {
          esUpdate = fixture('elastic-update-fixture');
          esUpdateBad = fixture('bad-id');
          
          client = new elasticsearch.Client({host: 'http://localhost:9200'});

          esUpdate.client = client;
          esUpdateBad.client = client;
        });

        test('defines the index property', function () {
          assert.equal(esUpdate.index, 'mockads');
          assert.equal(esUpdateBad.index, 'mockads');
        });

        test('defines the id property', function () {
          assert.equal(esUpdate.id, '3');
          assert.equal(esUpdateBad.id, '2didk');
        });

        test('defines the elastic-type property', function() {
          assert.deepEqual(esUpdate.elasticType, 'ad');
          assert.deepEqual(esUpdateBad.elasticType, 'ad');
        });

        test('other properties are initialized as null/undefined by default', function() {
          assert.isUndefined(esUpdate.body);
          assert.isUndefined(esUpdateBad.body);
          assert.isNull(esUpdate.results);
          assert.isNull(esUpdateBad.results);
          assert.isUndefined(esUpdate.lastError);
          assert.isUndefined(esUpdateBad.lastError);
        });

        test('does not have html content', function() {
          assert.deepEqual(Polymer.dom(esUpdate.root).children.length, 0);
        });

        test('performs an update', function (done) {
          esUpdate.addEventListener('results-changed', function (event) {
            assert.isUndefined(esUpdate.body);
            assert.equal(esUpdate.results._index, esUpdate.index);
            assert.equal(esUpdate.results._type, esUpdate.elasticType);
            assert.equal(esUpdate.results._id, esUpdate.id);
            assert.isNumber(esUpdate.results._version);
            assert.isUndefined(esUpdate.lastError);
            done();
          });
          esUpdate.body = {doc: {title: "shore, I thought I would sail about a\n"}};
        });

        test('if error occurs, persists error to lastError', function (done) {
          esUpdateBad.addEventListener('last-error-changed', function (event) {
            assert.isUndefined(esUpdateBad.body);
            assert.isDefined(esUpdateBad.lastError);
            done();
          });
          esUpdateBad.body = {doc: {title: "shore, I thought I would sail about a\n"}};
        });

      });
    </script>
  </body>
</html>
